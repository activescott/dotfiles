#!/usr/bin/env sh
THISDIR=$(cd $(dirname "$0"); pwd) #this script's directory

DATE=`date "+%Y-%m-%dT%H_%M_%S"`

cpsafe() {
 SRC=$1
 DST=$2
 if [ -f "$SRC" ]; then 
  [ -L "$DST" ] && echo "removing link $DST" && rm "$DST" #rm if link
  [ -f "$DST" ] && mv -v "$DST" "$DST.old-$DATE" #mv to "just in case" file
  ln -vs "$SRC" "$DST"
 else
  printf "\n *WARNING*: $SRC doesn't exist!\n\n"
  return 1
 fi
}

cpsafe_dir() {
 SRCDIR=$1
 DSTDIR=$2
 
[ -d "$DSTDIR" ] || mkdir -p "$DSTDIR"
for filepath in $SRCDIR/*; do
    filename=`basename $filepath`
    cpsafe "$filepath" "$DSTDIR/$filename"
done
 
}

DOTFILESDIR=$(dirname $THISDIR)

# ~/bin
echo "\n########## Copying $DOTFILESDIR/bin files... ##########"
[ -d "$HOME/bin" ] || mkdir -p "$HOME/bin"
for filepath in $DOTFILESDIR/bin/*; do
    filename=`basename $filepath`
    #echo "hi $filepath -> $filename"
    cpsafe "$filepath" ~/bin/$filename
done 

# ~/lib
echo "\n########## Copying $DOTFILESDIR/lib files... ##########"
[ -d "$HOME/lib" ] || mkdir -p "$HOME/lib"
for filepath in $DOTFILESDIR/lib/*; do
    filename=`basename $filepath`
    #echo "hi $filepath -> $filename"
    cpsafe "$filepath" ~/lib/$filename
done

# Midnight Commander:
echo "\n########## Copying Midnight Commander files... ##########"
cpsafe_dir "$DOTFILESDIR/.config/mc" ~/.config/mc

echo "\n########## Copying 1Password config files... ##########"
cpsafe_dir "$DOTFILESDIR/.config/1Password/ssh" ~/.config/1Password/ssh

echo "\n########## Copying k9s config files... ##########"
# k9s uses ~/Library/Application Support/k9s/ on macOS (not ~/.config/k9s/)
cpsafe_dir "$DOTFILESDIR/.config/k9s" "$HOME/Library/Application Support/k9s"

# misc apps, etc.
echo "\n########## Copying misc files... ##########"
cpsafe "$DOTFILESDIR/.bash_secrets" ~/.bash_secrets

# source common .<shell>rc stuff for bash and zsh:
cpsafe "$DOTFILESDIR/.shrc" ~/.shrc

# bash:
cpsafe "$DOTFILESDIR/.bashrc" ~/.bashrc
cpsafe "$DOTFILESDIR/.bash_profile" ~/.bash_profile

# zsh: https://linuxhint.com/configure-setup-zshrc-zsh/
cpsafe "$DOTFILESDIR/.zshrc" ~/.zshrc
cpsafe "$DOTFILESDIR/.zprofile" ~/.zprofile


echo "\n########## Copying SSH & git config files... ##########"
[ -d "~/.ssh/config" ] || mkdir -p "~/.ssh/config"
cpsafe "$DOTFILESDIR/.ssh/config" ~/.ssh/config

cpsafe "$DOTFILESDIR/.config/1Password/ssh/agent.toml" ~/.config/1Password/ssh/agent.toml


echo "\n########## Copying git config files... ##########"
cpsafe "$DOTFILESDIR/.gitconfig" ~/.gitconfig
cpsafe "$DOTFILESDIR/.ssh/authorized_keys" ~/.ssh/authorized_keys # for general ssh authorized access
cpsafe "$DOTFILESDIR/.ssh/allowed_signers" ~/.ssh/allowed_signers # for git's SSH commit verification
cpsafe "$DOTFILESDIR/.gitconfig.commit-signing-1p.include" ~/.gitconfig.commit-signing-1p.include
cpsafe "$DOTFILESDIR/.gitconfig.commit-signing-local.include" ~/.gitconfig.commit-signing-local.include
cpsafe "$DOTFILESDIR/.gitconfig.commit-signing-onlykey.include" ~/.gitconfig.commit-signing-onlykey.include
